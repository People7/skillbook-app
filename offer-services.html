<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Post Service</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .form-container { max-width: 600px; margin: auto; padding: 1rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; }
    input[type="text"], textarea, select { width: 100%; padding: 0.5rem; }
    .top-bar-right img { width: 36px; height: 36px; border-radius: 50%; }
    #contactOptions label { cursor: pointer; display: inline-block; margin-right: 10px; padding: 5px 10px; background: #eee; border-radius: 5px; }
    #contactOptions label.selected { background: #007bff; color: white; }
  </style>
</head>
<body>
  <div class="top-bar-right">
    <img src="https://via.placeholder.com/36" alt="User Profile" />
  </div>

  <div class="form-container">
    <h1>Post a New Service</h1>
    <form id="offerForm">
      <div class="form-group">
        <label for="serviceTitle">Service Title</label>
        <input type="text" name="serviceTitle" required />
      </div>
      <div class="form-group">
        <label for="category">Category</label>
        <select name="category" required>
          <option value="">Select Category</option>
          <option value="Design">Design</option>
          <option value="Development">Development</option>
          <option value="Writing">Writing</option>
          <option value="Marketing">Marketing</option>
        </select>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea name="description" rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label for="tags">Tags (comma separated)</label>
        <input type="text" name="tags" placeholder="e.g. logo, branding, graphic" />
      </div>
      <div class="form-group">
        <label>Preferred Contact Method</label>
        <div id="contactOptions">
          <label data-method="Chat">Chat</label>
          <label data-method="Email">Email</label>
          <label data-method="Phone">Phone</label>
          <label data-method="WhatsApp">WhatsApp</label>
        </div>
        <input type="hidden" id="preferredContact" name="preferredContact" value="Chat" />
      </div>
      <div class="form-group">
        <label for="imageUpload">Service Image</label>
        <input type="file" name="imageUpload" accept="image/*" />
      </div>
      <button type="submit">Publish</button>
    </form>
  </div>

  <!-- Contact Option Toggle Script -->
  <script>
    document.querySelectorAll('#contactOptions label').forEach(label => {
      label.addEventListener('click', () => {
        document.querySelectorAll('#contactOptions label').forEach(l => l.classList.remove('selected'));
        label.classList.add('selected');
        document.getElementById('preferredContact').value = label.dataset.method;
      });
    });
  </script>

  <!-- Firebase logic as a module -->
  <script type="module">
    import { db, storage, auth } from './firebase.js';
    import { doc, getDoc, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
    import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';

    const offerForm = document.getElementById('offerForm');
    const preferredContactField = document.getElementById('preferredContact');
    const profileImg = document.querySelector('.top-bar-right img');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please log in first.");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, 'users', user.uid);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        alert("Profile not found. Please complete your profile first.");
        window.location.href = "user-profile.html";
        return;
      }

      const profile = userSnap.data();
      profileImg.src = profile.profilePicUrl || 'https://via.placeholder.com/36';

      offerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const serviceTitle = offerForm.serviceTitle.value.trim();
        const category = offerForm.category.value;
        const description = offerForm.description.value.trim();
        const tags = offerForm.tags.value.trim();
        const preferredContact = preferredContactField.value;
        const imageFile = offerForm.imageUpload.files[0];

        let imageURL = '';
        if (imageFile) {
          const imageRef = ref(storage, `services/${user.uid}/${Date.now()}_${imageFile.name}`);
          const snapshot = await uploadBytes(imageRef, imageFile);
          imageURL = await getDownloadURL(snapshot.ref);
        }

        const serviceData = {
          serviceTitle,
          category,
          description,
          tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
          preferredContact,
          imageURL,
          userId: user.uid,
          createdAt: serverTimestamp(),
          userProfile: {
            name: profile.name || '',
            gender: profile.gender || '',
            mobile: profile.mobile || '',
            whatsapp: profile.whatsapp || '',
            email: profile.email || '',
            qualification: profile.qualification || '',
            experience: profile.experience || '',
            pincode: profile.pincode || '',
            area: profile.area || '',
            city: profile.city || '',
            state: profile.state || '',
            country: profile.country || 'India',
            profilePicUrl: profile.profilePicUrl || '',
          }
        };

        try {
          await addDoc(collection(db, 'services'), serviceData);
          alert("Service published successfully!");
          offerForm.reset();
          preferredContactField.value = "Chat";
          document.querySelectorAll('#contactOptions label').forEach(l => l.classList.remove('selected'));
          document.querySelector('#contactOptions label[data-method="Chat"]').classList.add('selected');
        } catch (error) {
          console.error("Error saving service:", error);
          alert("Failed to publish service. Please try again.");
        }
      });
    });
  </script>
</body>
</html>
